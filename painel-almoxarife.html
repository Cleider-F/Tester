<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel do Almoxarife ‚Äì Gest√£o de NI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family: Arial, Helvetica, sans-serif;
  background:#f3f4f6;
  padding:16px;
}

.container{
  max-width:650px;
  margin:auto;
}

.card{
  background:#fff;
  border-radius:14px;
  padding:18px;
  box-shadow:0 4px 10px rgba(0,0,0,.08);
  margin-bottom:16px;
}

h1{
  font-size:20px;
  text-align:center;
  margin-bottom:14px;
}

.input-group{
  display:flex;
  gap:10px;
}

input{
  flex:1;
  padding:12px;
  border-radius:10px;
  border:1px solid #d1d5db;
  font-size:16px;
}

button{
  padding:12px 16px;
  border:none;
  border-radius:10px;
  background:#111827;
  color:#fff;
  font-size:14px;
  cursor:pointer;
}

button:hover{opacity:.9}

.lista{
  display:flex;
  flex-direction:column;
  gap:10px;
}

.item{
  border-left:6px solid #dc2626;
  padding:12px 14px;
  background:#f9fafb;
  border-radius:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.item small{
  color:#6b7280;
  font-size:12px;
}

.desbloquear{
  background:#e5e7eb;
  color:#111827;
  font-size:12px;
  padding:8px 10px;
  border-radius:8px;
}

.desbloquear:hover{
  background:#dc2626;
  color:#fff;
}

.empty{
  text-align:center;
  color:#6b7280;
  font-size:14px;
  padding:20px;
}

/* Toast */
.toast{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:#111827;
  color:#fff;
  padding:12px 18px;
  border-radius:12px;
  font-size:14px;
  opacity:0;
  pointer-events:none;
  transition:.3s;
  z-index:2000;
}

.toast.show{opacity:1}
.toast.success{background:#16a34a}
.toast.warn{background:#f59e0b}
.toast.danger{background:#dc2626}

/* Sugest√µes */
.sugestoes{
  position:absolute;
  background:#fff;
  border:1px solid #d1d5db;
  border-radius:10px;
  width:100%;
  max-height:180px;
  overflow-y:auto;
  z-index:1000;
  margin-top:6px;
  display:none;
}

.sugestoes div{
  padding:10px;
  cursor:pointer;
  font-size:14px;
}

.sugestoes div:hover{
  background:#e5e7eb;
}

/* BOT√ÉO HAMBURGER */
.menu-btn{
  position:fixed;
  top:12px;
  left:12px;
  z-index:1001;
  background:#111827;
  color:#fff;
  border:none;
  border-radius:10px;
  font-size:22px;
  width:auto;
  height:auto;
  padding:8px 12px;
  margin:0;
}

/* SIDEBAR */
.sidebar{
  position:fixed;
  top:0;
  left:0;
  height:100%;
  width:260px;
  background:#111827;
  color:#fff;
  transform:translateX(-100%);
  transition:.3s;
  z-index:1002;
  display:flex;
  flex-direction:column;
}

.sidebar.active{
  transform:translateX(0);
}

/* HEADER */
.sidebar-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:16px;
  border-bottom:1px solid #1f2937;
}

.sidebar-header button{
  background:none;
  border:none;
  color:#fff;
  font-size:18px;
}

/* LINKS */
.sidebar nav{
  display:flex;
  flex-direction:column;
  padding:10px;
}

.sidebar nav a{
  padding:14px;
  border-radius:10px;
  color:#fff;
  text-decoration:none;
  margin-bottom:6px;
}

.sidebar nav a:hover{
  background:#1f2937;
}

.sidebar nav a.ativo{
  background:#2563eb;
}

/* OVERLAY */
.menu-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  z-index:1000;
  display:none;
}

.menu-overlay.active{
  display:block;
}

/* ====== Se√ß√µes colaps√°veis ====== */
.section-btn{
  width:100%;
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#111827;
  color:#fff;
  border-radius:12px;
  padding:12px 14px;
  font-size:14px;
  margin-top:10px;
}

.section-btn span{opacity:.9}
.section-content{
  display:none;
  margin-top:10px;
  background:#f9fafb;
  border:1px solid #e5e7eb;
  border-radius:12px;
  padding:12px;
}

.section-content.active{display:block}

label{
  display:block;
  font-size:13px;
  color:#374151;
  margin:8px 0 6px;
}

.input-stack{
  display:flex;
  flex-direction:column;
  gap:10px;
}

.btn-row{
  display:flex;
  gap:10px;
}

.btn-row button{flex:1}

.btn-green{background:#059669}
.btn-red{background:#dc2626}
.btn-gray{background:#6b7280}

.helper{
  font-size:12px;
  color:#6b7280;
  margin-top:8px;
  line-height:1.3;
}
</style>
</head>

<body>
<!-- BOT√ÉO HAMBURGER -->
<button class="menu-btn" onclick="abrirMenu()">‚ò∞</button>

<!-- OVERLAY -->
<div class="menu-overlay" onclick="fecharMenu()"></div>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-header">
    <strong>üì¶ Pedido de Pe√ßas</strong>
    <button onclick="fecharMenu()">‚úñ</button>
  </div>

  <nav>
    <a href="index.html">üìù Pedido de Pe√ßas</a>
    <a href="acompanhamento.html">üì¶ Acompanhamento de Pedidos üî©</a>
    <a href="admin.html">üîê √Årea de T√©cnicos üõ†Ô∏è</a>
    <a href="admin-epi.html">ü¶∫ EPI's e Uniformes</a>
    <a href="painel-almoxarife.html">üñ•Ô∏è Painel do Almoxarife ‚öôÔ∏è</a>
  </nav>
</aside>

<div class="container">

  <div class="card">
    <div class="header-admin" style="display:flex;justify-content:center;margin-bottom:8px;">
      <a href="index.html" class="btn-home" title="Voltar ao in√≠cio">üè†</a>
    </div>

    <h1>üß© Gest√£o de NI</h1>

    <!-- 1) ADD/UPDATE -->
    <button class="section-btn" type="button" onclick="toggleSection('secAdd')">
      <div>‚ûï Adicionar / Atualizar (aprendizado_ni)</div>
      <span id="icon-secAdd">‚ñº</span>
    </button>

    <div id="secAdd" class="section-content">
      <div class="input-stack">
        <div>
          <label>Nome da pe√ßa (descri√ß√£o)</label>
          <input id="aprDesc" placeholder="Ex: EMENDA R√ÅPIDA DE PL√ÅSTICO 8X8">
        </div>

        <div style="position:relative;">
          <label>NI</label>
          <input id="aprNi" placeholder="Ex: 27033747" inputmode="numeric">
          <div id="aprSugAdd" class="sugestoes"></div>
        </div>

        <div class="btn-row">
          <button class="btn-green" onclick="salvarAprendizado()">Salvar</button>
          <button class="btn-gray" onclick="limparAprendizadoAdd()">Limpar</button>
        </div>

        <div class="helper">
          Salva em <b>aprendizado_ni/{NI}</b> com <b>descricao</b>, <b>ni</b>, <b>validadoEm</b>.
        </div>
      </div>
    </div>

    <!-- 2) DELETE -->
    <button class="section-btn" type="button" onclick="toggleSection('secDel')">
      <div>üóëÔ∏è Excluir (aprendizado_ni)</div>
      <span id="icon-secDel">‚ñº</span>
    </button>

    <div id="secDel" class="section-content">
      <div class="input-stack">
        <div style="position:relative;">
          <label>NI para excluir</label>
          <input id="delNi" placeholder="Digite o NI (com sugest√£o)" inputmode="numeric">
          <div id="aprSugDel" class="sugestoes"></div>
        </div>

        <div class="helper" style="margin-top:6px;">
          <b>Pe√ßa:</b> <span id="delNomePeca">‚Äî</span>
        </div>

        <div class="btn-row">
          <button class="btn-red" onclick="excluirAprendizado()">Excluir</button>
          <button class="btn-gray" onclick="limparAprendizadoDel()">Limpar</button>
        </div>
      </div>
    </div>

    <!-- 3) BLOQUEAR -->
    <button class="section-btn" type="button" onclick="toggleSection('secBlock')">
      <div>üîí Bloquear NI (ni_bloqueados)</div>
      <span id="icon-secBlock">‚ñº</span>
    </button>

    <div id="secBlock" class="section-content">
      <div style="position:relative;width:100%">
        <div class="input-group">
          <input id="niInput" placeholder="Digite o NI ou descri√ß√£o da pe√ßa">
          <button onclick="bloquearNI()">Bloquear</button>
        </div>
        <div id="sugestoes" class="sugestoes"></div>

        <div class="helper">
          Usa sugest√£o de <b>aprendizado_ni</b> + sua lista local (lista_NI.js).
        </div>
      </div>
    </div>

    <!-- 4) LISTA BLOQUEADOS -->
    <button class="section-btn" type="button" onclick="toggleSection('secListBlock')">
      <div>üìã NIs bloqueados</div>
      <span id="icon-secListBlock">‚ñº</span>
    </button>

    <div id="secListBlock" class="section-content">
      <div id="listaNI" class="lista"></div>
    </div>

  </div>

</div>

<div id="toast" class="toast"></div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="lista_NI.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyCAJPyQ7-a4Efxxh5yTXQ_326hn22OYAuc",
  authDomain: "pedidos-almoxarifado.firebaseapp.com",
  projectId: "pedidos-almoxarifado",
  storageBucket: "pedidos-almoxarifado.appspot.com",
  messagingSenderId: "443882865992",
  appId: "1:443882865992:web:1afcc37c29bd8800eedf7d"
});

const db = firebase.firestore();
const toast = document.getElementById("toast");

const aprDesc = document.getElementById("aprDesc");
const aprNi = document.getElementById("aprNi");
const delNi = document.getElementById("delNi");
const delNomePeca = document.getElementById("delNomePeca");
const aprSugAdd = document.getElementById("aprSugAdd");
const aprSugDel = document.getElementById("aprSugDel");

const niInput = document.getElementById("niInput");
const sugestoesBox = document.getElementById("sugestoes");
const listaNI = document.getElementById("listaNI");

let baseNI = [];  // base geral (lista_NI + aprendizado_ni)  -> precisa ter rawDesc p/ descri√ß√£o
let baseApr = []; // base aprendizado_ni (para sugest√£o add/del e preview)

function normalizar(txt){
  return String(txt || "").toUpperCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g,"")
    .trim();
}

/* üîî Toast */
function showToast(msg, type="success"){
  toast.textContent = msg;
  toast.className = `toast show ${type}`;
  setTimeout(()=> toast.className="toast", 2500);
}

/* ======== MENU ======== */
window.abrirMenu = () => {
  document.querySelector(".sidebar").classList.add("active");
  document.querySelector(".menu-overlay").classList.add("active");
};
window.fecharMenu = () => {
  document.querySelector(".sidebar").classList.remove("active");
  document.querySelector(".menu-overlay").classList.remove("active");
};
/* destaca p√°gina atual */
document.querySelectorAll(".sidebar nav a").forEach(a=>{
  if(a.href === window.location.href){
    a.classList.add("ativo");
  }
});

/* ======== COLAPS√ÅVEL ======== */
window.toggleSection = (id) => {
  const el = document.getElementById(id);
  const icon = document.getElementById("icon-"+id);
  const active = el.classList.toggle("active");
  icon.textContent = active ? "‚ñ≤" : "‚ñº";
};

/* üîé Base de NI (lista local) */
function carregarListaNI(){
  if(!window.LISTA_NI) return;
  window.LISTA_NI.forEach(i=>{
    baseNI.push({
      descricao: normalizar(i.produto),
      ni: String(i.ni),
      rawDesc: i.produto // ‚úÖ importante p/ mostrar descri√ß√£o
    });
  });
}

/* üîé Base do aprendizado_ni */
function carregarAprendizadoNI(){
  baseApr = [];
  return db.collection("aprendizado_ni").get().then(snapshot=>{
    snapshot.forEach(doc=>{
      const d = doc.data() || {};
      const ni = String(d.ni ? d.ni : doc.id);
      const desc = d.descricao ? d.descricao : "";
      if(ni){
        baseNI.push({ descricao: normalizar(desc), ni, rawDesc: desc }); // ‚úÖ rawDesc aqui tamb√©m
        baseApr.push({ descricao: normalizar(desc), ni, rawDesc: desc });
      }
    });
  });
}

/* Carrega bases */
Promise.all([carregarAprendizadoNI()]).then(()=>{
  carregarListaNI();
  console.log("‚úÖ Base NI:", baseNI.length, "| baseApr:", baseApr.length);
});

/* ===== Helpers ===== */
function buscarDescPorNI(ni){
  const found = baseNI.find(x => String(x.ni) === String(ni));
  return (found && found.rawDesc) ? found.rawDesc : "";
}
function buscarPorDescricao(termoNormalizado){
  return baseNI.find(x => x.descricao.includes(termoNormalizado));
}

/* ===== PREVIEW EXCLUS√ÉO ===== */
function atualizarPreviewExclusao(){
  const ni = delNi.value.trim();
  if(!ni){
    delNomePeca.textContent = "‚Äî";
    return;
  }
  const found = baseApr.find(x => String(x.ni) === String(ni));
  delNomePeca.textContent = (found && found.rawDesc) ? found.rawDesc : "N√£o encontrado na cole√ß√£o";
}

/* ===========================
   APRENDIZADO_NI (ADD/DEL)
=========================== */

/* Autocomplete NI (ADD) */
aprNi.addEventListener("input", ()=>{
  const termo = normalizar(aprNi.value);
  if(termo.length < 2){ aprSugAdd.style.display="none"; return; }

  const resultados = baseApr
    .filter(i => i.ni.includes(termo) || i.descricao.includes(termo))
    .slice(0,6);

  if(!resultados.length){ aprSugAdd.style.display="none"; return; }

  aprSugAdd.innerHTML = resultados.map(r=>`
    <div onclick="selecionarAprAdd('${r.ni}')">
      ${r.descricao}
      <span style="font-size:11px;color:#6b7280"> | NI ${r.ni}</span>
    </div>
  `).join("");
  aprSugAdd.style.display="block";
});

window.selecionarAprAdd = (ni) => {
  aprNi.value = ni;
  const found = baseApr.find(x=>x.ni===ni);
  if(found && found.rawDesc && !aprDesc.value.trim()){
    aprDesc.value = found.rawDesc;
  }
  aprSugAdd.style.display="none";
};

/* Autocomplete NI (DEL) */
delNi.addEventListener("input", ()=>{
  const termo = normalizar(delNi.value);
  atualizarPreviewExclusao();

  if(termo.length < 2){ aprSugDel.style.display="none"; return; }

  const resultados = baseApr
    .filter(i => i.ni.includes(termo) || i.descricao.includes(termo))
    .slice(0,6);

  if(!resultados.length){ aprSugDel.style.display="none"; return; }

  aprSugDel.innerHTML = resultados.map(r=>`
    <div onclick="selecionarAprDel('${r.ni}')">
      ${r.descricao}
      <span style="font-size:11px;color:#6b7280"> | NI ${r.ni}</span>
    </div>
  `).join("");
  aprSugDel.style.display="block";
});

window.selecionarAprDel = (ni) => {
  delNi.value = ni;
  aprSugDel.style.display="none";
  atualizarPreviewExclusao();
};

/* Salvar no aprendizado_ni: docId = NI */
window.salvarAprendizado = async () => {
  try{
    const descricao = aprDesc.value.trim();
    const ni = aprNi.value.trim();

    if(!descricao){
      showToast("Informe o nome da pe√ßa (descri√ß√£o).","warn");
      return;
    }
    if(!ni || ni.length < 3){
      showToast("Informe um NI v√°lido.","warn");
      return;
    }
    if(/^0+$/.test(ni)){
      showToast("NI n√£o pode ser 0000...","warn");
      return;
    }

    await db.collection("aprendizado_ni").doc(ni).set({
      descricao,
      ni,
      validadoEm: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge:true });

    showToast(`Salvo no aprendizado_ni: NI ${ni}`,"success");

    // Recarrega bases
    baseNI = [];
    await carregarAprendizadoNI();
    carregarListaNI();

    aprDesc.value = "";
    aprNi.value = "";
    aprSugAdd.style.display="none";
  }catch(e){
    console.error(e);
    showToast("Erro ao salvar: "+(e.message||e),"danger");
  }
};

window.limparAprendizadoAdd = () => {
  aprDesc.value = "";
  aprNi.value = "";
  aprSugAdd.style.display="none";
};

/* Excluir do aprendizado_ni: docId = NI */
window.excluirAprendizado = async () => {
  try{
    const ni = delNi.value.trim();
    if(!ni){
      showToast("Digite o NI para excluir.","warn");
      return;
    }

    const ref = db.collection("aprendizado_ni").doc(ni);
    const snap = await ref.get();

    if(!snap.exists){
      showToast("NI n√£o encontrado no aprendizado_ni.","warn");
      atualizarPreviewExclusao();
      return;
    }

    const desc = snap.data()?.descricao || "";
    if(!confirm(`Excluir do aprendizado_ni?\n\nNI: ${ni}\nPe√ßa: ${desc}`)) return;

    await ref.delete();

    showToast(`Exclu√≠do: NI ${ni}`,"success");

    // Recarrega bases
    baseNI = [];
    await carregarAprendizadoNI();
    carregarListaNI();

    delNi.value = "";
    aprSugDel.style.display="none";
    delNomePeca.textContent = "‚Äî";
  }catch(e){
    console.error(e);
    showToast("Erro ao excluir: "+(e.message||e),"danger");
  }
};

window.limparAprendizadoDel = () => {
  delNi.value = "";
  aprSugDel.style.display="none";
  delNomePeca.textContent = "‚Äî";
};

/* ===========================
   BLOQUEIO DE NI (COM DESCRI√á√ÉO)
=========================== */

/* ‚å®Ô∏è Enter */
niInput.addEventListener("keydown", e=>{
  if(e.key==="Enter") bloquearNI();
});

/* üîç Autocomplete do bloqueio */
niInput.addEventListener("input", ()=>{
  const termo = normalizar(niInput.value);
  if(termo.length < 2){
    sugestoesBox.style.display="none";
    return;
  }

  const resultados = baseNI
    .filter(i => i.descricao.includes(termo) || i.ni.includes(termo))
    .slice(0,6);

  if(!resultados.length){
    sugestoesBox.style.display="none";
    return;
  }

  sugestoesBox.innerHTML = resultados.map(r=>`
    <div onclick="selecionarSugestao('${r.ni}')">
      ${r.descricao}
      <span style="font-size:11px;color:#6b7280">
        | NI ${r.ni}
      </span>
    </div>
  `).join("");

  sugestoesBox.style.display="block";
});

window.selecionarSugestao = ni =>{
  niInput.value = ni;
  sugestoesBox.style.display="none";
};

/* üîí Bloquear NI (corrigido: aceita NI OU descri√ß√£o e salva descricao) */
async function bloquearNI(){
  const raw = niInput.value.trim();
  if(!raw) return;

  // Se o usu√°rio digitou um NI puro (ou com caracteres), pega s√≥ n√∫meros
  const soNumeros = raw.replace(/\D/g,"");
  let niFinal = "";
  let descFinal = "";

  if(soNumeros.length >= 3){
    // veio NI
    niFinal = soNumeros;
    descFinal = buscarDescPorNI(niFinal);
  } else {
    // veio texto -> tenta achar na base e extrair o NI
    const termo = normalizar(raw);
    const found = buscarPorDescricao(termo);
    if(found){
      niFinal = String(found.ni);
      descFinal = found.rawDesc || "";
    }
  }

  if(!niFinal){
    showToast("N√£o consegui identificar o NI. Selecione uma sugest√£o ou digite o NI.","warn");
    return;
  }

  try{
    const ref = db.collection("ni_bloqueados").doc(niFinal);
    const snap = await ref.get();
    if(snap.exists){
      showToast("NI j√° est√° bloqueado","warn");
      return;
    }

    await ref.set({
      descricao: descFinal || "",
      bloqueadoEm: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge:true });

    niInput.value="";
    showToast(`NI ${niFinal} bloqueado`,"success");
  }catch(e){
    console.error(e);
    showToast("Erro ao bloquear: "+(e.message||e),"danger");
  }
}

/* üìã Lista de bloqueados (mostra descri√ß√£o) */
db.collection("ni_bloqueados")
.orderBy("bloqueadoEm","desc")
.onSnapshot(snapshot=>{
  listaNI.innerHTML="";

  if(snapshot.empty){
    listaNI.innerHTML = `
      <div class="empty">
        ‚úÖ Nenhum NI bloqueado no momento
      </div>`;
    return;
  }

  snapshot.forEach(doc=>{
    const dataObj = doc.data() || {};
    const data = dataObj.bloqueadoEm?.toDate();
    const fmt = data ? data.toLocaleDateString("pt-BR") : "";

    // prioridade: descricao salva no doc; se vazio, tenta base; sen√£o fallback
    const desc = (dataObj.descricao && String(dataObj.descricao).trim())
      ? dataObj.descricao
      : (buscarDescPorNI(doc.id) || "(sem descri√ß√£o)");

    listaNI.innerHTML += `
      <div class="item">
        <div>
          <strong>üî¥ ${desc}</strong><br>
          <small>NI: ${doc.id} ‚Ä¢ Bloqueado em: ${fmt}</small>
        </div>
        <button class="desbloquear" onclick="confirmarRemocao('${doc.id}')">
          Desbloquear
        </button>
      </div>
    `;
  });
});

/* üóëÔ∏è Remover bloqueio */
function confirmarRemocao(ni){
  if(!confirm(`Remover bloqueio do NI ${ni}?`)) return;
  db.collection("ni_bloqueados").doc(ni).delete()
    .then(()=> showToast(`NI ${ni} desbloqueado`,"success"))
    .catch(e=> showToast("Erro: "+(e.message||e),"danger"));
}
</script>

</body>
</html>