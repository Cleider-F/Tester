<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Bloqueio de NI ‚Äì Almoxarifado</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family: Arial, Helvetica, sans-serif;
  background:#f3f4f6;
  padding:16px;
}

.container{
  max-width:650px;
  margin:auto;
}

.card{
  background:#fff;
  border-radius:14px;
  padding:18px;
  box-shadow:0 4px 10px rgba(0,0,0,.08);
  margin-bottom:16px;
}

h1{
  font-size:20px;
  text-align:center;
  margin-bottom:14px;
}

.input-group{
  display:flex;
  gap:10px;
}

input{
  flex:1;
  padding:12px;
  border-radius:10px;
  border:1px solid #d1d5db;
  font-size:16px;
}

button{
  padding:12px 16px;
  border:none;
  border-radius:10px;
  background:#111827;
  color:#fff;
  font-size:14px;
  cursor:pointer;
}

button:hover{opacity:.9}

.lista{
  display:flex;
  flex-direction:column;
  gap:10px;
}

.item{
  border-left:6px solid #dc2626;
  padding:12px 14px;
  background:#f9fafb;
  border-radius:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.item small{
  color:#6b7280;
  font-size:12px;
}

.desbloquear{
  background:#e5e7eb;
  color:#111827;
  font-size:12px;
  padding:8px 10px;
  border-radius:8px;
}

.desbloquear:hover{
  background:#dc2626;
  color:#fff;
}

.empty{
  text-align:center;
  color:#6b7280;
  font-size:14px;
  padding:20px;
}

/* Toast */
.toast{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:#111827;
  color:#fff;
  padding:12px 18px;
  border-radius:12px;
  font-size:14px;
  opacity:0;
  pointer-events:none;
  transition:.3s;
}

.toast.show{opacity:1}
.toast.success{background:#16a34a}
.toast.warn{background:#f59e0b}

/* Sugest√µes */
.sugestoes{
  position:absolute;
  background:#fff;
  border:1px solid #d1d5db;
  border-radius:10px;
  width:100%;
  max-height:180px;
  overflow-y:auto;
  z-index:1000;
  margin-top:6px;
  display:none;
}

.sugestoes div{
  padding:10px;
  cursor:pointer;
  font-size:14px;
}

.sugestoes div:hover{
  background:#e5e7eb;
}
</style>
</head>

<body>

<div class="container">

  <div class="card">
    <div class="header-admin">
    <a href="index.html" class="btn-home" title="Voltar ao in√≠cio">üè†</a>
    </div>
    <h1>üîí Bloqueio de NI</h1>

    <div style="position:relative;width:100%">
      <div class="input-group">
        <input id="niInput" placeholder="Digite o NI ou descri√ß√£o da pe√ßa">
        <button onclick="bloquearNI()">Bloquear</button>
      </div>
      <div id="sugestoes" class="sugestoes"></div>
    </div>
  </div>

  <div class="card">
    <div id="listaNI" class="lista"></div>
  </div>

</div>

<div id="toast" class="toast"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="lista_NI.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyCAJPyQ7-a4Efxh5yTXQ_326hn22OYAUc",
  authDomain: "pedidos-almoxarifado.firebaseapp.com",
  projectId: "pedidos-almoxarifado",
  storageBucket: "pedidos-almoxarifado.appspot.com",
  messagingSenderId: "443882865992",
  appId: "1:443882865992:web:1afcc37c29bd8800eedf7d"
});

const db = firebase.firestore();
const toast = document.getElementById("toast");
const niInput = document.getElementById("niInput");
const sugestoesBox = document.getElementById("sugestoes");
const listaNI = document.getElementById("listaNI");

let baseNI = [];

function normalizar(txt){
  return txt.toUpperCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g,"")
    .trim();
}

/* üîé Base de NI */
function carregarListaNI(){
  if(!window.LISTA_NI) return;
  window.LISTA_NI.forEach(i=>{
  baseNI.push({
    descricao: normalizar(i.produto),
    ni: String(i.ni) // üî• converte n√∫mero ‚Üí string
  });
});
}
carregarListaNI();

function carregarAprendizadoNI(){
  return db.collection("aprendizado_ni").get().then(snapshot=>{
    snapshot.forEach(doc=>{
      const d = doc.data();
      if(d.descricao && d.ni){
        baseNI.push({
          descricao: normalizar(d.descricao),
          ni: String(d.ni)
        });
      }
    });
  });
}

Promise.all([
  carregarAprendizadoNI()
]).then(()=>{
  carregarListaNI();
  console.log("‚úÖ Base NI carregada:", baseNI.length);
});

/* üîî Toast */
function showToast(msg, type="success"){
  toast.textContent = msg;
  toast.className = `toast show ${type}`;
  setTimeout(()=> toast.className="toast", 2500);
}

/* ‚å®Ô∏è Enter */
niInput.addEventListener("keydown", e=>{
  if(e.key==="Enter") bloquearNI();
});

/* üîç Autocomplete */
niInput.addEventListener("input", ()=>{
  const termo = normalizar(niInput.value);
  if(termo.length < 2){
    sugestoesBox.style.display="none";
    return;
  }

  const resultados = baseNI
    .filter(i => i.descricao.includes(termo) || i.ni.includes(termo))
    .slice(0,6);

  if(!resultados.length){
    sugestoesBox.style.display="none";
    return;
  }

  sugestoesBox.innerHTML = resultados.map(r=>`
    <div onclick="selecionarSugestao('${r.ni}')">
      ${r.descricao}
      <span style="font-size:11px;color:#6b7280">
        | NI ${r.ni}
      </span>
    </div>
  `).join("");

  sugestoesBox.style.display="block";
});

window.selecionarSugestao = ni =>{
  niInput.value = ni;
  sugestoesBox.style.display="none";
};

/* üîí Bloquear NI */
function bloquearNI(){
  const ni = niInput.value.trim();
  if(!ni) return;

  db.collection("ni_bloqueados").doc(ni).get().then(doc=>{
    if(doc.exists){
      showToast("NI j√° est√° bloqueado","warn");
      return;
    }

    db.collection("ni_bloqueados").doc(ni).set({
      bloqueadoEm: firebase.firestore.FieldValue.serverTimestamp()
    }).then(()=>{
      niInput.value="";
      showToast(`NI ${ni} bloqueado`);
    });
  });
}

/* üìã Lista */
db.collection("ni_bloqueados")
.orderBy("bloqueadoEm","desc")
.onSnapshot(snapshot=>{
  listaNI.innerHTML="";

  if(snapshot.empty){
    listaNI.innerHTML = `
      <div class="empty">
        ‚úÖ Nenhum NI bloqueado no momento
      </div>`;
    return;
  }

  snapshot.forEach(doc=>{
    const data = doc.data().bloqueadoEm?.toDate();
    const fmt = data ? data.toLocaleDateString("pt-BR") : "";

    listaNI.innerHTML += `
      <div class="item">
        <div>
          <strong>üî¥ NI ${doc.id}</strong><br>
          <small>Bloqueado em: ${fmt}</small>
        </div>
        <button class="desbloquear" onclick="confirmarRemocao('${doc.id}')">
          Desbloquear
        </button>
      </div>
    `;
  });
});

/* üóëÔ∏è Remover */
function confirmarRemocao(ni){
  if(!confirm(`Remover bloqueio do NI ${ni}?`)) return;
  db.collection("ni_bloqueados").doc(ni).delete()
    .then(()=> showToast(`NI ${ni} desbloqueado`));
}
</script>

</body>
</html>
