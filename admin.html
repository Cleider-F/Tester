<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Admin ‚Äì Almoxarifado CMC</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<!-- jsPDF + AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, getDocs, doc, updateDoc, query, orderBy, addDoc, getDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ================= FIREBASE ================= */
const firebaseConfig = {
 apiKey: "AIzaSyBsF6D5l1dXR4rSR3axpFrD-idXh2ZaRUE",

  authDomain: "testeer-1516c.firebaseapp.com",

  projectId: "testeer-1516c",

  storageBucket: "testeer-1516c.firebasestorage.app",

  messagingSenderId: "1030430919430",

  appId: "1:1030430919430:web:22224089ad1c80f8a56c87"

};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= UTIL ================= */
function norm(txt){
  return txt.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();
}

async function aprenderNI(pecas){
  for(const p of pecas){
    if(p.ni){
      await addDoc(collection(db,'aprendizado_ni'),{
        descricao: norm(p.descricao),
        ni: p.ni,
        validadoEm: new Date()
      });
    }
  }
}

const lista = document.getElementById('listaPedidos');

/* ================= PEDIDOS ================= */
async function carregarPedidos(){
  lista.innerHTML='';
  let pend=0, apr=0, rep=0;

  const q = query(collection(db,'pedidos'), orderBy('criadoEm','desc'));
  const snap = await getDocs(q);

  const pedidos = [];
  snap.forEach(d=>pedidos.push({id:d.id, ...d.data()}));

  pedidos.sort((a,b)=>{
    if(a.status==='Pendente' && b.status!=='Pendente') return -1;
    if(a.status!=='Pendente' && b.status==='Pendente') return 1;
    return 0;
  });

  for(const p of pedidos){
    if(p.status==='Pendente') pend++;
    if(p.status==='Aprovado') apr++;
    if(p.status==='Reprovado') rep++;

    const card = document.createElement('div');
    card.className='card';

    const pecasHtml = p.pecas.map((x,i)=>`
      <div class="peca">
        ${x.descricao} (${x.quantidade})<br>
        <input placeholder="NI" value="${x.ni||''}" ${p.status!=='Pendente'?'disabled':''}
          onchange="window.atualizarNI('${p.id}',${i},this.value)">
      </div>
    `).join('');

    card.innerHTML = `
      <div class="card-header">
        <span class="card-status ${p.status}">${p.status}</span>
      </div>
      <div class="card-body">
        <p><b>Solicitante:</b> ${p.nome}</p>
        <p><b>Manuten√ß√£o:</b> ${p.manutencao}</p>
        <p><b>GO:</b> ${p.go||'-'}</p>
        <p><b>Pe√ßas:</b></p>
        ${pecasHtml}
        ${p.aprovadoPor?`<p><b>Aprovado por:</b> ${p.aprovadoPor}</p>`:''}
      </div>
      ${p.status==='Pendente'?`
      <div class="card-footer">
        <button class="aprovar" onclick="aprovar('${p.id}')">‚úî Aprovar</button>
        <button class="reprovar" onclick="reprovar('${p.id}')">‚úñ Reprovar</button>
      </div>`:''}
    `;

    lista.appendChild(card);
  }

  document.getElementById('qtdPendentes').innerText=pend;
  document.getElementById('qtdAprovados').innerText=apr;
  document.getElementById('qtdReprovados').innerText=rep;
  document.getElementById('qtdTotal').innerText=pend+apr+rep;
}

/* ================= A√á√ïES ================= */
window.atualizarNI = async(id, index, ni)=>{
  const ref = doc(db,'pedidos',id);
  const snap = await getDoc(ref);
  if(!snap.exists()) return;
  const pedido = snap.data();
  pedido.pecas[index].ni = ni.trim();
  await updateDoc(ref,{ pecas: pedido.pecas });
};

window.aprovar = async(id)=>{
  const nome = localStorage.getItem('usuario_nome')||'Administrador';
  const ref = doc(db,'pedidos',id);
  const snap = await getDoc(ref);
  if(!snap.exists()) return;
  const pedido = snap.data();

  await updateDoc(ref,{ status:'Aprovado', aprovadoPor:nome, finalizadoEm:new Date() });
  await aprenderNI(pedido.pecas);
  window.mostrarAba = (aba)=>{
  document.getElementById('aba-pedidos').style.display = aba==='pedidos'?'block':'none';
  document.getElementById('aba-relatorios').style.display = aba==='relatorios'?'block':'none';
  document.querySelectorAll('.aba').forEach(b=>b.classList.remove('ativa'));
  event.target.classList.add('ativa');
};

carregarPedidos();
};

window.reprovar = async(id)=>{
  const nome = localStorage.getItem('usuario_nome')||'Administrador';
  const ref = doc(db,'pedidos',id);
  await updateDoc(ref,{ status:'Reprovado', aprovadoPor:nome, finalizadoEm:new Date() });
  carregarPedidos();
};

/* ================= RELAT√ìRIOS ================= */
window.gerarRelatorioPDF = async()=>{
  const inicio = document.getElementById('relInicio').value;
  const fim = document.getElementById('relFim').value;

  const jsPDFLib = window.jspdf?.jsPDF;
  if(!jsPDFLib){ alert('jsPDF n√£o carregado'); return; }

  const pdf = new jsPDFLib({orientation:'landscape'});

  const q = query(collection(db,'pedidos'), orderBy('criadoEm','desc'));
  const snap = await getDocs(q);

  const rows=[];
  snap.forEach(d=>{
    const p=d.data();
    const data=p.criadoEm?.toDate?.()||new Date();
    if(inicio && data < new Date(inicio)) return;
    if(fim && data > new Date(fim+'T23:59:59')) return;

    rows.push([
      p.nome,
      p.manutencao,
      p.go||'-',
      p.pecas.map(x=>`${x.descricao} (${x.quantidade}) NI:${x.ni||'-'}`).join(' | '),
      p.status,
      p.aprovadoPor||'-'
    ]);
  });

  pdf.autoTable({
    head:[["Solicitante","Manuten√ß√£o","GO","Pe√ßas","Status","Aprovado por"]],
    body:rows
  });

  pdf.save('relatorio-geral-pedidos.pdf');
};

window.gerarRelatorioExcel = async()=>{
  const inicio = document.getElementById('relInicio').value;
  const fim = document.getElementById('relFim').value;

  const q = query(collection(db,'pedidos'), orderBy('criadoEm','desc'));
  const snap = await getDocs(q);

  let csv = 'Solicitante;Manuten√ß√£o;GO;Pe√ßas;Status;Aprovado por\n';

  snap.forEach(d=>{
    const p=d.data();
    const data=p.criadoEm?.toDate?.()||new Date();
    if(inicio && data < new Date(inicio)) return;
    if(fim && data > new Date(fim+'T23:59:59')) return;

    const pecas = p.pecas.map(x=>`${x.descricao} (${x.quantidade}) NI:${x.ni||'-'}`).join(' | ');
    csv += `${p.nome};${p.manutencao};${p.go||'-'};${pecas};${p.status};${p.aprovadoPor||'-'}\n`;
  });

  const blob = new Blob([csv],{type:'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'relatorio-geral-pedidos.csv';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
};

carregarPedidos();
</script>

<style>
*{box-sizing:border-box;font-family:'Inter',sans-serif}
body{margin:0;background:#f3f4f6;color:#111827}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.08)}
.container{max-width:1200px;margin:auto;padding:20px}
.cards-resumo{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-bottom:24px}
.resumo{padding:20px;border-radius:16px;color:#fff}
.pendente{background:#facc15;color:#78350f}
.aprovado{background:#22c55e}
.reprovado{background:#ef4444}
.total{background:#3b82f6}
.lista{display:grid;gap:14px}
.card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 6px 16px rgba(0,0,0,.08)}
.card-status{padding:4px 12px;border-radius:999px;font-weight:600;font-size:13px}
.card-status.Pendente{background:#fef3c7;color:#92400e}
.card-status.Aprovado{background:#dcfce7;color:#166534}
.card-status.Reprovado{background:#fee2e2;color:#991b1b}
.card-footer{display:flex;gap:10px;margin-top:12px}
button{border:none;color:#fff;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
button.aprovar{background:#22c55e}
button.reprovar{background:#ef4444}
.peca input{width:100%;margin-top:6px;padding:8px;border-radius:8px;border:1px solid #d1d5db}
@media(max-width:600px){.card-footer{flex-direction:column}}
.abas{display:flex;gap:10px;margin-bottom:20px}
.aba{background:#e5e7eb;color:#111827}
.aba.ativa{background:#3b82f6;color:#fff}
</style>
</head>
<body>
<div class="topbar">
  <button onclick="location.href='index.html'">üè†</button>
  <h1>√Årea de T√©cnicos ‚Äì Almoxarifado CMC</h1>
</div>
<div class="container">
  <div class="abas">
    <button class="aba ativa" onclick="mostrarAba('pedidos')">üì¶ Pedidos</button>
    <button class="aba" onclick="mostrarAba('relatorios')">üìä Relat√≥rios</button>
  </div>

  <div id="aba-pedidos">
  <div class="cards-resumo">
    <div class="resumo pendente">Pendentes<br><span id="qtdPendentes">0</span></div>
    <div class="resumo aprovado">Aprovados<br><span id="qtdAprovados">0</span></div>
    <div class="resumo reprovado">Reprovados<br><span id="qtdReprovados">0</span></div>
    <div class="resumo total">Total<br><span id="qtdTotal">0</span></div>
  </div>

  </div>

  <div id="aba-relatorios" style="display:none">
  <div class="relatorios-box">
    <h2>üìä Relat√≥rio Geral de Pedidos</h2>
    <div class="filtros">
      <input type="date" id="relInicio">
      <input type="date" id="relFim">
      <button onclick="gerarRelatorioPDF()">üìÑ PDF</button>
      <button onclick="gerarRelatorioExcel()">üìä Excel</button>
    </div>
  </div>

    </div>
  </div>

  <div class="lista" id="listaPedidos"></div>
</div>
</body>
</html>
