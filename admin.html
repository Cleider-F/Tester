<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>√Årea de Pedidos ‚Äì Almoxarifado CMC</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest-admin.json">
<meta name="theme-color" content="#111827">

<style>
body {
  font-family: Arial, Helvetica, sans-serif;
  background:#f2f2f2;
  padding:15px;
}
.logo { text-align:center; margin-bottom:15px; }
.logo img { max-width:160px; width:100%; }

footer {
  text-align:center;
  margin-top:25px;
  font-size:11px;
  color:#6b7280;
}

.login, .painel {
  max-width:1200px;
  margin:auto;
  background:#fff;
  padding:15px;
  border-radius:12px;
  box-shadow:0 4px 10px rgba(0,0,0,.1);
}

h2 { text-align:center; }
input { padding:6px; margin-top:4px; }

button {
  padding:6px 10px;
  margin:2px;
  cursor:pointer;
  border:none;
  border-radius:6px;
}

.aprovar { background:#16a34a; color:#fff; }
.reprovar { background:#dc2626; color:#fff; }

.btn-excluir {
  background:none;
  border:none;
  color:#dc2626;
  font-size:16px;
  cursor:pointer;
}

table {
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}

th, td {
  border:1px solid #ccc;
  padding:6px;
  font-size:13px;
  vertical-align:top;
}

th { background:#f3f4f6; }

.status-pendente { color:#ca8a04; font-weight:bold; }
.status-aprovado { color:#16a34a; font-weight:bold; }
.status-reprovado { color:#dc2626; font-weight:bold; }

/* üî• VISUAL ANTIGO PARA PEDIDO PENDENTE */
tr.card-pendente {
  background:#fffbeb;
  border-left:6px solid #f59e0b;
}

tr.card-pendente td {
  background:transparent;
}

/* üì± MOBILE */
@media (max-width: 768px) {
  table, thead, tbody, th, td, tr { display:block }
  thead { display:none }

  tr {
    background:#fff;
    margin-bottom:15px;
    border-radius:12px;
    padding:12px;
    box-shadow:0 4px 10px rgba(0,0,0,.08);
  }

  tr.card-pendente {
    background:#fffbeb;
    border-left:6px solid #f59e0b;
  }

  td {
    border:none;
    padding:6px 0;
    font-size:14px;
  }

  td::before {
    content: attr(data-label);
    font-weight:bold;
    display:block;
    color:#374151;
    margin-bottom:2px;
  }

  .acoes-mobile button {
    width:100%;
    margin-top:6px;
  }
}
</style>
</head>

<body>

<div class="logo">
  <a href="index.html">
    <img src="suzano-logo.png">
  </a>
</div>

<footer>
  Criado e Desenvolvido por Cleider Filho
</footer>

<div class="login" id="loginBox">
  <h2>üîê √Årea de T√©cnicos</h2>
  <input type="password" id="senha" placeholder="Senha">
  <button id="btnLogin">Entrar</button>
</div>

<div class="painel" id="painel" style="display:none">
  <h2>üì¶ Pedidos Recebidos</h2>

  <button onclick="logout()" style="background:#111827;color:#fff;margin-bottom:10px">
    üö™ Sair
  </button>

  <div style="margin-bottom:15px;display:flex;gap:10px;flex-wrap:wrap">
    <button onclick="gerarRelatorio()">üìÑ Relat√≥rio do dia (PDF)</button>

    <div>
      <label>Data inicial</label><br>
      <input type="date" id="dataInicio">
    </div>

    <div>
      <label>Data final</label><br>
      <input type="date" id="dataFim">
    </div>

    <button onclick="gerarRelatorioPeriodo()">üìÑ Relat√≥rio por per√≠odo (PDF)</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Solicitante</th>
        <th>Manuten√ß√£o</th>
        <th>GO</th>
        <th>Pe√ßas (NI edit√°vel)</th>
        <th>Criado em</th>
        <th>Aprovado</th>
        <th>Status</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="lista"></tbody>
  </table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, getDocs,
  doc, updateDoc, getDoc, query, orderBy,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* FIREBASE */
const app = initializeApp({
  apiKey: "AIzaSyCAJPyQ7-a4Efxh5yTXQ_326hn22OYAUc",
  authDomain: "pedidos-almoxarifado.firebaseapp.com",
  projectId: "pedidos-almoxarifado"
});
const db = getFirestore(app);

/* TELEGRAM */
const TELEGRAM_TOKEN = "8229775934:AAEEIKF5ffP_rVvbosRilvPyb3wZ0fVBFLU";
const TELEGRAM_CHAT_ID = "-1003646317990";

/* LOGIN */
btnLogin.onclick = () => {
  localStorage.setItem("adminLogado","true");
  localStorage.setItem("adminNome","Admin");
  loginBox.style.display="none";
  painel.style.display="block";
  carregarPedidos();
};

window.logout = () => {
  localStorage.clear();
  location.reload();
};

/* LISTAR PEDIDOS */
async function carregarPedidos() {
  lista.innerHTML="";
  const q=query(collection(db,"pedidos"),orderBy("criadoEm","desc"));
  const snap=await getDocs(q);

  for (const d of snap.docs) {
    const p=d.data();
    const classe = p.status==="Pendente" ? "card-pendente" : "";

    lista.innerHTML+=`
<tr class="${classe}">
  <td data-label="Solicitante">${p.nome}</td>
  <td data-label="Manuten√ß√£o">${p.manutencao}</td>
  <td data-label="GO">${p.go||"-"}</td>
  <td data-label="Pe√ßas">
    ${p.pecas.map((x,i)=>`
      <div>
        <b>${x.descricao}</b> (${x.quantidade})<br>
        NI:
        <input value="${x.ni ?? ""}"
          onchange="atualizarNI('${d.id}',${i},'${x.descricao}',this.value)">
      </div>
    `).join("<hr>")}
  </td>
  <td data-label="Criado em">${new Date(p.criadoEm.seconds*1000).toLocaleString("pt-BR")}</td>
  <td data-label="Aprovado">${p.aprovadoPor||"-"}</td>
  <td data-label="Status"><span class="status-${p.status.toLowerCase()}">${p.status}</span></td>
  <td data-label="A√ß√µes" class="acoes-mobile">
    ${(p.status==="Pendente"||p.status==="Reprovado") ? `
      ${p.status==="Pendente" ? `
        <button class="aprovar" onclick="mudarStatus('${d.id}','Aprovado')">‚úÖ Aprovar</button>
        <button class="reprovar" onclick="mudarStatus('${d.id}','Reprovado')">‚ùå Reprovar</button>
      ` : ``}
      <button class="btn-excluir" onclick="excluirPedido('${d.id}')">‚ùå Excluir</button>
    ` : "‚Äî"}
  </td>
</tr>`;
  }
}

/* EXCLUIR */
window.excluirPedido = async (id) => {
  if (!confirm("Excluir este pedido definitivamente?")) return;
  await deleteDoc(doc(db,"pedidos",id));
  carregarPedidos();
};

/* STATUS */
window.mudarStatus = async (id, status) => {
  const ref = doc(db,"pedidos",id);
  const snap = await getDoc(ref);
  const p = snap.data();
  const aprovadoPor = localStorage.getItem("adminNome");

  await updateDoc(ref,{ status, aprovadoPor, aprovadoEm:new Date() });

  if (status==="Aprovado") {
    p.status="Aprovado";
    p.aprovadoPor=aprovadoPor;
    notificarAprovacao(p);
  }

  carregarPedidos();
};

/* TELEGRAM */
window.notificarAprovacao = (p) => {
  const pecas = p.pecas
    .map(x => `‚Ä¢ ${x.descricao} (${x.quantidade})`)
    .join("\n");

  const mensagem =
`‚úÖ *PEDIDO APROVADO*

üë§ *Solicitante:* ${p.nome}
üõ† *Manuten√ß√£o:* ${p.manutencao}
üìÑ *GO:* ${p.go || "-"}

üì¶ *Pe√ßas:*
${pecas}

üë®‚Äçüîß *Aprovado por:* ${p.aprovadoPor}
‚è∞ *Data:* ${new Date().toLocaleString("pt-BR")}
`;

  fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      chat_id: TELEGRAM_CHAT_ID,
      text: mensagem,
      parse_mode: "Markdown"
    })
  });
};

/* RELAT√ìRIOS */
window.gerarRelatorio = () => gerarRelatorioPeriodo(true);
window.gerarRelatorioPeriodo = async () => {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("landscape");

  const snap = await getDocs(collection(db,"pedidos"));
  const linhas = [];

  snap.forEach(d=>{
    const p=d.data();
    linhas.push([
      p.nome,p.manutencao,p.go||"-",
      p.pecas.map(x=>`${x.descricao} (${x.quantidade})`).join("\n"),
      p.status
    ]);
  });

  pdf.autoTable({
    startY:20,
    head:[["Solicitante","Manuten√ß√£o","GO","Pe√ßas","Status"]],
    body:linhas
  });

  pdf.save("relatorio-pedidos.pdf");
};

/* AUTO LOGIN */
if(localStorage.getItem("adminLogado")==="true"){
  loginBox.style.display="none";
  painel.style.display="block";
  carregarPedidos();
}
</script>

</body>
</html>