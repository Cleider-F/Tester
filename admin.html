<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>√Årea de Pedidos ‚Äì Almoxarifado CMC</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest-admin.json">
<meta name="theme-color" content="#111827">

<style>
body {
  font-family: Arial, Helvetica, sans-serif;
  background:#f2f2f2;
  padding:15px;
}
.logo { text-align:center; margin-bottom:15px; }
.logo img { max-width:160px; width:100%; }

.login, .painel {
  max-width:1200px;
  margin:auto;
  background:#fff;
  padding:15px;
  border-radius:12px;
  box-shadow:0 4px 10px rgba(0,0,0,.1);
}

h2 { text-align:center; }
input { padding:6px; margin-top:4px; }

button {
  padding:6px 10px;
  margin:2px;
  cursor:pointer;
  border:none;
  border-radius:6px;
}

.aprovar { background:#16a34a; color:#fff; }
.reprovar { background:#dc2626; color:#fff; }

table {
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}

th, td {
  border:1px solid #ccc;
  padding:6px;
  font-size:13px;
  vertical-align:top;
}

th { background:#f3f4f6; }

.status-pendente { color:#ca8a04; font-weight:bold; }
.status-aprovado { color:#16a34a; font-weight:bold; }
.status-reprovado { color:#dc2626; font-weight:bold; }

footer {
  text-align:center;
  margin-top:25px;
  font-size:11px;
  color:#6b7280;
}

/* üì± RESPONSIVO ‚Äì MOBILE */
@media (max-width: 768px) {

  table, thead, tbody, th, td, tr {
    display: block;
  }

  thead {
    display: none;
  }

  tr {
    background: #f9fafb;
    margin-bottom: 15px;
    border-radius: 10px;
    padding: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,.08);
  }

  td {
    border: none;
    padding: 6px 0;
    font-size: 14px;
  }

  td::before {
    content: attr(data-label);
    display: block;
    font-weight: bold;
    color: #374151;
    margin-bottom: 2px;
  }

  input {
    width: 100% !important;
    box-sizing: border-box;
  }

  button {
    width: 100%;
    margin-top: 6px;
  }
}

</style>
</head>

<body>

<div class="logo">
  <a href="index.html">
    <img src="suzano-logo.png">
  </a>
</div>

<div class="login" id="loginBox">
  <h2>üîê √Årea de T√©cnicos</h2>
  <input type="password" id="senha" placeholder="Senha">
  <button id="btnLogin">Entrar</button>
</div>

<div class="painel" id="painel" style="display:none">
  <h2>üì¶ Pedidos Recebidos</h2>

  <button onclick="logout()" style="background:#111827;color:#fff;margin-bottom:10px">
    üö™ Sair
  </button>

  <div style="margin-bottom:15px;display:flex;gap:10px;flex-wrap:wrap">
    <button onclick="gerarRelatorio()">üìÑ Relat√≥rio do dia (PDF)</button>

    <div>
      <label>Data inicial</label><br>
      <input type="date" id="dataInicio">
    </div>

    <div>
      <label>Data final</label><br>
      <input type="date" id="dataFim">
    </div>

    <button onclick="gerarRelatorioPeriodo()">üìÑ Relat√≥rio por per√≠odo (PDF)</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Solicitante</th>
        <th>Manuten√ß√£o</th>
        <th>GO</th>
        <th>Pe√ßas (NI edit√°vel)</th>
        <th>Criado em</th>
        <th>Aprovado</th>
        <th>Status</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="lista"></tbody>
  </table>
</div>

<footer>
  Criado e Desenvolvido por Cleider Filho
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, getDocs,
  doc, updateDoc, getDoc, query, orderBy, addDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* FIREBASE */
const app = initializeApp({
  apiKey: "AIzaSyBsF6D5l1dXR4rSR3axpFrD-idXh2ZaRUE",
  authDomain: "testeer-1516c.firebaseapp.com",
  projectId: "testeer-1516c",
  storageBucket: "testeer-1516c.firebasestorage.app",
  messagingSenderId: "1030430919430",
  appId: "1:1030430919430:web:22224089ad1c80f8a56c87"
});
const db = getFirestore(app);

/* TELEGRAM */
const TELEGRAM_TOKEN = "8229775934:AAEEIKF5ffP_rVvbosRilvPyb3wZ0fVBFLU";
const TELEGRAM_CHAT_ID = "-1003208006500";

/* USU√ÅRIOS */
const USUARIOS = {
  "otto2026": "Leonardo Otto",
  "salles2026": "Douglas Salles",
  "robson2026": "Robson dos Santos",
  "gleyson2026": "Gleyson Mur√ßa",
  "cleiton2026": "Cleiton Castro",
  "junior2026": "Geraldo Junior",
  "amanda2026": "Amanda",
  "mariana2026": "Mariana",
  "breno2026": "Breno",
  "luiz2026": "Luis",
  "cleider": "Cleider Filho"
};

/* NORMALIZA√á√ÉO */
function normalizar(txt) {
  return txt
    .toUpperCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g,"")
    .trim();
}

/* BUSCAR NI NO APRENDIZADO */
async function buscarNIporAprendizado(descricao) {
  const termo = normalizar(descricao);
  const snap = await getDocs(collection(db,"ni_aprendizado"));

  let encontrado = null;
  snap.forEach(d=>{
    const a = d.data();
    if (termo.includes(a.termo)) {
      encontrado = a.ni;
    }
  });

  return encontrado;
}

/* LOGIN */
btnLogin.onclick = () => {
  const nome = USUARIOS[senha.value];
  if (!nome) return alert("Senha incorreta");
  localStorage.setItem("adminLogado","true");
  localStorage.setItem("adminNome",nome);
  loginBox.style.display="none";
  painel.style.display="block";
  carregarPedidos();
};

window.logout = () => {
  localStorage.clear();
  location.reload();
};

/* LISTAR PEDIDOS */
async function carregarPedidos() {
  lista.innerHTML = "";
  const q = query(collection(db,"pedidos"), orderBy("criadoEm","desc"));
  const snap = await getDocs(q);

  for (const d of snap.docs) {
    const p = d.data();

    for (let i=0;i<p.pecas.length;i++) {
      if (!p.pecas[i].ni) {
        const niAprendido = await buscarNIporAprendizado(p.pecas[i].descricao);
        if (niAprendido) {
          p.pecas[i].ni = niAprendido;
          await updateDoc(doc(db,"pedidos",d.id),{ pecas:p.pecas });
        }
      }
    }

    lista.innerHTML += `
<tr>
<td data-label="Solicitante">${p.nome}</td>
<td data-label="Manuten√ß√£o">${p.manutencao}</td>
<td data-label="GO">${p.go || "-"}</td>
<td>
${p.pecas.map((x,i)=>`
<div>
<b>${x.descricao}</b> (${x.quantidade})<br>
NI:
<input value="${x.ni ?? ""}"
onchange="atualizarNI('${d.id}',${i},'${x.descricao}',this.value)"
style="width:100px">
</div>
`).join("<hr>")}
</td>
<td>${new Date(p.criadoEm.seconds*1000).toLocaleString("pt-BR")}</td>
<td>${p.aprovadoPor || "-"}</td>
<td class="status-${p.status.toLowerCase()}">${p.status}</td>
<td>
${p.status==="Pendente"
? `<button class="aprovar" onclick="mudarStatus('${d.id}','Aprovado')">‚úÖ</button>
   <button class="reprovar" onclick="mudarStatus('${d.id}','Reprovado')">‚ùå</button>`
: "‚Äî"}
</td>
</tr>`;
  }
}

/* ATUALIZAR NI + APRENDER */
window.atualizarNI = async (id, idx, descricao, ni) => {
  const ref = doc(db,"pedidos",id);
  const snap = await getDoc(ref);
  const p = snap.data();

  p.pecas[idx].ni = ni || null;
  await updateDoc(ref,{ pecas:p.pecas });

  if (ni) {
    await addDoc(collection(db,"ni_aprendizado"),{
      termo: normalizar(descricao),
      ni
    });
  }
};

/* üì≤ TELEGRAM ‚Äì NOTIFICA√á√ÉO DE APROVA√á√ÉO */
window.notificarAprovacao = function (p) {
  const texto = `
‚úÖ PEDIDO APROVADO

Solicitante: ${p.nome}
Manuten√ß√£o: ${p.manutencao}
GO: ${p.go || "-"}

Pe√ßas:
${p.pecas.map(x =>
`- ${x.descricao}
NI: ${x.ni ?? "N√ÉO INFORMADO"}
Qtd: ${x.quantidade}`
).join("\n\n")}

Aprovado por: ${localStorage.getItem("adminNome")}
`;

  fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      chat_id: TELEGRAM_CHAT_ID,
      text: texto
    })
  });
};

/* STATUS */
window.mudarStatus = async (id, status) => {
  const ref = doc(db,"pedidos",id);
  const snap = await getDoc(ref);
  const p = snap.data();

  if (p.status !== "Pendente") return;

  const aprovadoPor = localStorage.getItem("adminNome");

  await updateDoc(ref,{
    status,
    aprovadoEm: new Date(),
    aprovadoPor
  });

  // üîî TELEGRAM (AGORA FUNCIONA)
  if (status === "Aprovado") {
    p.status = "Aprovado";
    p.aprovadoPor = aprovadoPor;
    notificarAprovacao(p);
  }

  carregarPedidos();
};


/* RELAT√ìRIOS */
window.gerarRelatorio = () => gerarRelatorioPeriodo(true);

window.gerarRelatorioPeriodo = async (somenteHoje=false)=>{
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("landscape");

  const inicio = somenteHoje
    ? new Date(new Date().setHours(0,0,0,0))
    : new Date(dataInicio.value+"T00:00:00");

  const fim = somenteHoje
    ? new Date(new Date().setHours(23,59,59,999))
    : new Date(dataFim.value+"T23:59:59");

  const snap = await getDocs(collection(db,"pedidos"));
  const linhas = [];

  snap.forEach(d=>{
    const p=d.data();
    if(!p.criadoEm) return;
    const criado=new Date(p.criadoEm.seconds*1000);
    if(criado<inicio||criado>fim) return;
    linhas.push([
      p.nome,p.manutencao,p.go||"-",
      p.pecas.map(x=>`${x.descricao} (${x.quantidade})`).join("\n"),
      criado.toLocaleString("pt-BR"),
      p.aprovadoPor||"-",
      p.status
    ]);
  });

  pdf.autoTable({
    startY:20,
    head:[["Solicitante","Manuten√ß√£o","GO","Pe√ßas","Pedido","Aprovado","Status"]],
    body:linhas,
    styles:{fontSize:9}
  });

  pdf.save("relatorio-pedidos.pdf");
};

/* AUTO LOGIN */
if (localStorage.getItem("adminLogado")==="true") {
  loginBox.style.display="none";
  painel.style.display="block";
  carregarPedidos();
}
</script>

</body>
</html>
