<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>√Årea de Pedidos ‚Äì Almoxarifado CMC</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest-admin.json">
<meta name="theme-color" content="#111827">

<style>
body {
  font-family: Arial, Helvetica, sans-serif;
  background:#f2f2f2;
  padding:15px;
}
.logo { text-align:center; margin-bottom:15px; }
.logo img { max-width:160px; width:100%; }

footer {
  text-align:center;
  margin-top:25px;
  font-size:11px;
  color:#6b7280;
}

.login, .painel {
  max-width:1200px;
  margin:auto;
  background:#fff;
  padding:15px;
  border-radius:12px;
  box-shadow:0 4px 10px rgba(0,0,0,.1);
}

h2 { text-align:center; }

button {
  padding:8px 12px;
  cursor:pointer;
  border:none;
  border-radius:8px;
  font-size:14px;
}

.aprovar { background:#16a34a; color:#fff; }
.reprovar { background:#dc2626; color:#fff; }
.aprovar:disabled {
  background:#9ca3af;
  cursor:not-allowed;
}

.btn-excluir {
  background:none;
  border:none;
  color:#dc2626;
  font-size:16px;
  cursor:pointer;
}

.top-actions {
  display:flex;
  gap:10px;
  margin-bottom:15px;
}

.btn-sair { background:#111827; color:#fff; }
.btn-refresh { background:#2563eb; color:#fff; }

.relatorio-box {
  display:flex;
  gap:15px;
  flex-wrap:wrap;
  align-items:flex-end;
  background:#f9fafb;
  padding:12px;
  border-radius:10px;
  margin-bottom:15px;
}

table {
  width:100%;
  border-collapse:collapse;
}

th, td {
  border:1px solid #ccc;
  padding:6px;
  font-size:13px;
  vertical-align:top;
}

th { background:#f3f4f6; }

.status-pendente { color:#ca8a04; font-weight:bold; }
.status-aprovado { color:#16a34a; font-weight:bold; }
.status-reprovado { color:#dc2626; font-weight:bold; }

tr.card-pendente {
  background:#fffbeb;
  border-left:6px solid #f59e0b;
}

.selo-finalizado {
  background:#e5e7eb;
  padding:6px 10px;
  border-radius:20px;
  font-size:12px;
  font-weight:bold;
  text-align:center;
}
</style>
</head>

<body>

<div class="logo">
  <img src="suzano-logo.png">
</div>

<footer>Criado e Desenvolvido por Cleider Filho</footer>

<div class="login" id="loginBox">
  <h2>üîê √Årea de T√©cnicos</h2>
  <input type="password" id="senha" placeholder="Senha">
  <button id="btnLogin">Entrar</button>
</div>

<div class="painel" id="painel" style="display:none">
  <h2>üì¶ Pedidos Recebidos</h2>

  <div class="top-actions">
    <button class="btn-sair" onclick="logout()">üö™ Sair</button>
    <button class="btn-refresh" onclick="carregarPedidos()">üîÑ Atualizar</button>
  </div>

  <div class="relatorio-box">
    <button onclick="gerarRelatorio()">üìÑ Relat√≥rio do dia</button>
    <input type="date" id="dataInicio">
    <input type="date" id="dataFim">
    <button onclick="gerarRelatorioPeriodo()">üìÑ Relat√≥rio por per√≠odo</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Solicitante</th>
        <th>Manuten√ß√£o</th>
        <th>GO</th>
        <th>Pe√ßas (NI)</th>
        <th>Status</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="lista"></tbody>
  </table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, getDocs, addDoc,
  doc, updateDoc, getDoc, query, orderBy, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* FIREBASE */
const app = initializeApp({
  apiKey: "AIzaSyBsF6D5l1dXR4rSR3axpFrD-idXh2ZaRUE",
  authDomain: "testeer-1516c.firebaseapp.com",
  projectId: "testeer-1516c"
});
const db = getFirestore(app);

/* TELEGRAM */
const TELEGRAM_TOKEN = "8229775934:AAEEIKF5ffP_rVvbosRilvPyb3wZ0fVBFLU";
const TELEGRAM_CHAT_ID = "-1003208006500";

/* LOGIN */
btnLogin.onclick = () => {
  localStorage.setItem("adminLogado","true");
  localStorage.setItem("adminNome","T√©cnico");
  loginBox.style.display="none";
  painel.style.display="block";
  carregarPedidos();
};

window.logout = () => {
  localStorage.clear();
  location.reload();
};

/* NORMALIZAR */
function normalizar(txt){
  return txt.toUpperCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g,"")
    .trim();
}

/* LISTAR PEDIDOS */
async function carregarPedidos() {
  lista.innerHTML="";
  const q=query(collection(db,"pedidos"),orderBy("criadoEm","desc"));
  const snap=await getDocs(q);

  snap.forEach(d=>{
    const p=d.data();
    const finalizado = p.status!=="Pendente";
    const faltaNI = p.pecas.some(x=>!x.ni);

    lista.innerHTML+=`
<tr class="${p.status==="Pendente"?"card-pendente":""}">
<td>${p.nome}</td>
<td>${p.manutencao}</td>
<td>${p.go||"-"}</td>
<td>
${p.pecas.map((x,i)=>`
${x.descricao}<br>
<input value="${x.ni||""}"
${finalizado?"disabled":""}
onchange="atualizarNI('${d.id}',${i},this.value)">
`).join("<hr>")}
</td>
<td><span class="status-${p.status.toLowerCase()}">${p.status}</span></td>
<td>
${finalizado
? `<div class="selo-finalizado">‚úî Pedido Finalizado</div>`
: `
<button class="aprovar" ${faltaNI?"disabled":""}
onclick="mudarStatus('${d.id}','Aprovado')">Aprovar</button>
<button class="reprovar"
onclick="mudarStatus('${d.id}','Reprovado')">Reprovar</button>
<button class="btn-excluir"
onclick="excluirPedido('${d.id}')">‚ùå</button>
`}
</td>
</tr>`;
  });
}

/* ATUALIZAR NI */
window.atualizarNI = async (id, idx, ni)=>{
  const ref=doc(db,"pedidos",id);
  const snap=await getDoc(ref);
  const p=snap.data();
  p.pecas[idx].ni=ni;
  await updateDoc(ref,{pecas:p.pecas});
};

/* SALVAR APRENDIZADO */
async function salvarAprendizado(pedido){
  for(const p of pedido.pecas){
    if(!p.ni) continue;
    await addDoc(collection(db,"aprendizado_ni"),{
      descricao: normalizar(p.descricao),
      ni: p.ni,
      validadoPor: localStorage.getItem("adminNome"),
      validadoEm: new Date()
    });
  }
}

/* STATUS */
window.mudarStatus = async (id, status)=>{
  const ref=doc(db,"pedidos",id);
  const snap=await getDoc(ref);
  const p=snap.data();

  if(p.status!=="Pendente"){
    alert("Pedido j√° finalizado.");
    return;
  }

  await updateDoc(ref,{
    status,
    aprovadoPor:localStorage.getItem("adminNome"),
    aprovadoEm:new Date()
  });

  if(status==="Aprovado"){
    await salvarAprendizado(p);
    notificarAprovacao(p);
  }

  carregarPedidos();
};

/* TELEGRAM APROVA√á√ÉO */
function notificarAprovacao(p){
  const pecas=p.pecas.map(x=>
`‚Ä¢ ${x.descricao} (${x.quantidade}) | NI: ${x.ni}`).join("\n");

  const msg=
`‚úÖ PEDIDO APROVADO

Solicitante: ${p.nome}
Manuten√ß√£o: ${p.manutencao}
GO: ${p.go||"-"}

Pe√ßas:
${pecas}`;

  fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ chat_id:TELEGRAM_CHAT_ID, text:msg })
  });
}

/* EXCLUIR */
window.excluirPedido = async (id)=>{
  if(!confirm("Excluir pedido pendente?")) return;
  await deleteDoc(doc(db,"pedidos",id));
  carregarPedidos();
};

/* RELAT√ìRIOS */
window.gerarRelatorio = () => gerarRelatorioPeriodo(true);

window.gerarRelatorioPeriodo = async ()=>{
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("landscape");

  const snap = await getDocs(collection(db,"pedidos"));
  const linhas=[];

  snap.forEach(d=>{
    const p=d.data();
    linhas.push([
      p.nome,
      p.manutencao,
      p.go||"-",
      p.pecas.map(x=>`${x.descricao} (${x.quantidade})`).join("\n"),
      p.status
    ]);
  });

  pdf.autoTable({
    head:[["Solicitante","Manuten√ß√£o","GO","Pe√ßas","Status"]],
    body:linhas
  });

  pdf.save("relatorio-pedidos.pdf");
};

/* AUTO LOGIN */
if(localStorage.getItem("adminLogado")==="true"){
  loginBox.style.display="none";
  painel.style.display="block";
  carregarPedidos();
}
</script>

</body>
</html>