<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Ãrea de TÃ©cnicos CMC</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest-admin.json">
<meta name="theme-color" content="#111827">

<style>
body{
  font-family:Arial,Helvetica,sans-serif;
  background:#f3f4f6;
  padding:12px;

}
.logo{text-align:center;margin-bottom:10px}
.logo img{max-width:150px;width:100%}

footer{
  text-align:center;
  margin-top:20px;
  font-size:11px;
  color:#6b7280;
}

.login,.painel{
  max-width:1200px;
  margin:auto;
  background:#fff;
  padding:15px;
  border-radius:14px;
  box-shadow:0 4px 10px rgba(0,0,0,.1);
}

h2{text-align:center;margin-bottom:10px}

.top-actions{
  display:center;
  justify-content:flex-start;
  flex-wrap:wrap;
  gap:10px;
  margin-bottom:15px;
}

.btn-atualizar{
  margin-left:auto;
}

button{
  border:none;
  padding:10px;
  border-radius:10px;
  cursor:pointer;
  font-size:14px;
}

.btn-sair{background:#111827;color:#fff}
.btn-refresh{background:#2abf3b;color:#fff}
.btn-atualizar{background:#2563eb;color:#fff}

.relatorio-box{
  background:#f9fafb;
  padding:12px;
  border-radius:12px;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-bottom:15px;
}

.relatorio-box button{background:#16a34a;color:#fff}

.cards{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(340px,1fr));
  gap:14px;
}

.card{
  background:#ffffff;
  border-left:6px solid transparent;
  border-radius:16px;
  padding:14px;
  box-shadow:0 4px 10px rgba(0,0,0,.08);
  position:relative;
}

.card-pendente{
  background:#fffbeb;
  border-left-color:#f59e0b;
}

.card-aprovado{
  background:#ffffff;
  border-left-color:#16a34a;
}

.card-reprovado{
  background:#ffffff;
  border-left-color:#dc2626;
}

.info{margin-bottom:8px;font-size:14px}
.info b{display:block;color:#374151}

.status{font-weight:bold;margin-bottom:8px}
.status-pendente{color:#ca8a04}
.status-aprovado{color:#16a34a}
.status-reprovado{color:#dc2626}

.peca{
  margin-top:10px;
  padding-top:8px;
  border-top:1px dashed #d1d5db;
}

.peca input{
  width:100%;
  padding:8px;
  margin-top:6px;
  border-radius:8px;
  border:1px solid #ccc;
}

.acoes{
  display:flex;
  flex-direction:column;
  gap:8px;
  margin-top:12px;
}

.aprovar{background:#16a34a;color:#fff}
.reprovar{background:#dc2626;color:#fff}
.aprovar:disabled{background:#9ca3af;cursor:not-allowed}

.btn-excluir{
  position:absolute;
  top:10px;
  right:10px;
  background:none;
  color:#dc2626;
  font-size:18px;
}

.selo{
  background:#e5e7eb;
  padding:10px;
  border-radius:12px;
  text-align:center;
  font-weight:bold;
}
.header-admin{
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:15px;
}

.header-admin h2{
  flex:1;
  text-align:center;
  margin:0;
}

.btn-home{
  text-decoration:none;
  font-size:20px;
  background:#e5e7eb;
  border-radius:10px;
  padding:8px 10px;
  box-shadow:0 2px 4px rgba(0,0,0,.1);
}

.btn-home:hover{
  background:#d1d5db;
}

.card-devolucao{
  border-left-color:#2563eb;
}

.selo-devolucao{
  background:#dbeafe;
  color:#1e40af;
  font-weight:bold;
  text-align:center;
  padding:6px;
  border-radius:8px;
  margin-bottom:8px;
}

</style>
</head>

<body>

<div class="logo">
  <img src="suzano-logo.png">
</div>

<div class="login" id="loginBox">
  <h2>ğŸ” Ãrea de TÃ©cnicos</h2>
  <input type="password" id="senha" placeholder="Senha">
  <button onclick="login()">Entrar</button>
</div>

<div class="painel" id="painel" style="display:none">
 <div class="header-admin">
  <a href="index.html" class="btn-home" title="Voltar ao inÃ­cio">ğŸ </a>
  <h2>ğŸ“¦ Pedidos Recebidos</h2>
</div>

<div style="display:flex;gap:10px;justify-content:center;margin-bottom:15px">
<button onclick="salvarTokenPush('novo')">ğŸ”” Push Novo Pedido</button>
<button onclick="salvarTokenPush('status')">ğŸ”” Push Status Pedido</button>
</div>

  <div class="top-actions">
  <div style="display:flex; gap:10px;">
    <button class="btn-sair" onclick="logout()">ğŸšª Sair</button>
    <button class="btn-refresh" onclick="toggleRelatorio()">ğŸ“Š RelatÃ³rios</button>
    <button class="btn-atualizar" onclick="location.reload()">ğŸ”„ Atualizar</button>
</div>

<div class="relatorio-box" id="relatorioBox" style="display:none;">
  <button onclick="gerarRelatorioDia()">ğŸ“„ RelatÃ³rio do dia</button>

  <button onclick="gerarRelatorioPeriodo()">ğŸ“„ RelatÃ³rio por perÃ­odo</button>

  <br><input type="date" id="inicio">
  <input type="date" id="fim"></br>

  <button onclick="relatorioPecasDia()">ğŸ“¦ PeÃ§as mais usadas hoje</button>
  <button onclick="relatorioPecasSemana()">ğŸ“¦ PeÃ§as mais usadas na semana</button>
</div>

  <div class="cards" id="lista"></div>
</div>

<footer>Criado e Desenvolvido por Cleider Filho</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, getDocs, addDoc,
  doc, updateDoc, getDoc, query, orderBy, arrayUnion,
  deleteDoc, limit, where, setDoc} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";


window.toggleRelatorio = () => {
  const box = document.getElementById("relatorioBox");
  box.style.display = box.style.display === "none" ? "flex" : "none";
};

/* FIREBASE */
const app=initializeApp({
   apiKey: "AIzaSyCAJPyQ7-a4Efxxh5yTXQ_326hn22OYAuc",

  authDomain: "pedidos-almoxarifado.firebaseapp.com",

  projectId: "pedidos-almoxarifado",

  storageBucket: "pedidos-almoxarifado.firebasestorage.app",

  messagingSenderId: "443882865992",

  appId: "1:443882865992:web:1afcc37c29bd8800eedf7d"
});
const db=getFirestore(app);
const messaging = getMessaging(app);

(async () => {
  if ("serviceWorker" in navigator) {
    swRegistration = await navigator.serviceWorker.register(
      "/Tester/firebase-messaging-sw.js",
      { scope: "/Tester/" }
    );
  }
})();

/* TELEGRAM */
const TELEGRAM_TOKEN = "8229775934:AAEEIKF5ffP_rVvbosRilvPyb3wZ0fVBFLU";
const TELEGRAM_CHAT_ID = "-1003646317990";

async function enviarTelegram(msg){
  await fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      chat_id: TELEGRAM_CHAT_ID,
      text: msg,
      parse_mode: "Markdown"
    })
  });
}

/* USUÃRIOS */
const USUARIOS = {
  "cleider": "Cleider Filho",
  "salles2026": "Douglas Salles",
  "gleyson2026": "Gleyson MurÃ§a",
  "robson2026": "Robson Jesus",
  "otto2026": "Leonardo Otto",
  "junior2026": "Geraldo Junior",
  "cleiton2026": "Cleiton Castro",
  "amanda2026": "Amanda",
  "mariana2026": "Mariana",
  "couto2026": "Grazy Couto",
  "breno2026": "Breno",
  "luiz2026": "Luiz",
  "joaquim2026": "Joaquim Pereira",
  "reginaldo2026": "Reginaldo Bocafoli"
};


/* LOGIN */
window.login = () => {
  const senha = document.getElementById("senha").value;

  if (!USUARIOS[senha]) {
    alert("Senha invÃ¡lida");
    return;
  }

  localStorage.setItem("admin", "true");
  localStorage.setItem("usuario_nome", USUARIOS[senha]);

  loginBox.style.display = "none";
  painel.style.display = "block";
  carregarPedidos();
};

window.logout=()=>{localStorage.clear();location.reload()}

/* PUSH NOTIFICATIONS */
let swRegistration = null;

(async () => {
  if ("serviceWorker" in navigator) {
    swRegistration = await navigator.serviceWorker.register(
      "/Tester/firebase-messaging-sw.js",
      { scope: "/Tester/" }
    );
  }
})();

async function salvarTokenPush(tipo) {
  if (!swRegistration) {
    alert("Service Worker nÃ£o pronto");
    return;
  }

  const permission = await Notification.requestPermission();
  if (permission !== "granted") {
    alert("PermissÃ£o negada");
    return;
  }

  const token = await getToken(messaging, {
    vapidKey: "BFjRfkUJ8hXuoy7gWDDfUzSN28VQxTFrR2UrYgxLe_1oZehIdFVfNHdZba21LN9afSHWiKUppajQ2fQGeWR3-n0",
    serviceWorkerRegistration: swRegistration
  });

  if (!token) {
    alert("Token nÃ£o gerado");
    return;
  }

  const nome = localStorage.getItem("usuario_nome");
  const ref = doc(db, "admin_push_tokens", nome);

  // ğŸ” BUSCA O DOCUMENTO DO USUÃRIO
  const snap = await getDoc(ref);
  const dados = snap.exists() ? snap.data() : {};
  const tokensAtuais = dados.fcmTokens || [];

  // ğŸ›‘ EVITA TOKEN DUPLICADO
  if (tokensAtuais.includes(token)) {
    alert("Este celular jÃ¡ estÃ¡ registrado para receber notificaÃ§Ãµes");
    return;
  }

  const payload = {
    nome,
    perfil: "admin",
    fcmTokens: arrayUnion(token),
    atualizadoEm: new Date()
  };

  if (tipo === "novo") payload.ativo_novo_pedido = true;
  if (tipo === "status") payload.ativo_status_pedido = true;

  await setDoc(ref, payload, { merge: true });

  alert("Push ativado com sucesso neste dispositivo ğŸ“²");
}
window.salvarTokenPush = salvarTokenPush;

//window.ativarPushNovo = salvarTokenPush;//
//window.ativarPushStatus = salvarTokenPush;//

 /* ATUALIZAR PEDIDOS */
  window.carregarPedidos = async function(){
  lista.innerHTML = "";

  const q = query(
    collection(db,"admin_push_tokens"),
    orderBy("criadoEm","desc"),
    limit(25)
  );

  const snap = await getDocs(q);

  snap.forEach(doc => {
    renderPedido(doc.id, doc.data());
  });
}; 
  
/* NORMALIZAR */
const norm=t=>t.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();

/* CARREGAR */
async function carregarPedidos(){
  lista.innerHTML="";
  const q = query(
  collection(db,"pedidos"),
  orderBy("criadoEm", "desc"),
  limit(25)
);
  const snap = await getDocs(q);

// transforma em array
const pedidos = [];
snap.forEach(d => {
  pedidos.push({ id: d.id, ...d.data() });
});

// ordena: Pendentes primeiro
pedidos.sort((a, b) => {
  if (a.status === "Pendente" && b.status !== "Pendente") return -1;
  if (a.status !== "Pendente" && b.status === "Pendente") return 1;
  return 0; // mantÃ©m ordem original (data)
});

// renderiza
pedidos.forEach(p => {
  const finalizado = p.status !== "Pendente";
  const faltaNI = p.pecas.some(x => !x.ni);

  lista.innerHTML += `
<div class="card card-${p.status.toLowerCase()} ${p.tipo === "DEVOLUCAO" ? "card-devolucao" : ""}">
${!finalizado ? `<button class="btn-excluir" onclick="excluir('${p.id}')">âŒ</button>` : ""}

<div class="status status-${p.status.toLowerCase()}">${p.status}</div>
${p.tipo === "DEVOLUCAO"
  ? `<div class="selo-devolucao">ğŸ” PEDIDO DE DEVOLUÃ‡ÃƒO</div>`
  : ""}

<div class="info"><b>Solicitante</b>${p.nome}</div>
<div class="info"><b>ManutenÃ§Ã£o</b>${p.manutencao}</div>
<div class="info"><b>GO</b>${p.go || "-"}</div>

<div class="info"><b>PeÃ§as</b></div>

${p.pecas.map((x,i)=>`
<div class="peca">
<b>${x.descricao} (${x.quantidade})</b>
<input value="${x.ni||""}" ${finalizado?"disabled":""}
onchange="atualizarNI('${p.id}',${i},this.value)">
</div>`).join("")}

<div class="acoes">
${finalizado
?`
<div class="selo">
âœ” Pedido ${p.status}<br>
ğŸ‘·â€â™‚ï¸ ${p.aprovadoPor || "-"}
</div>
`
:`
<button class="aprovar" ${faltaNI?"disabled":""}
onclick="mudarStatus('${p.id}','Aprovado')">âœ… Aprovar</button>
<button class="reprovar"
onclick="mudarStatus('${p.id}','Reprovado')">âŒ Reprovar</button>`}
</div>

</div>`;
});
}

/* NI */
window.atualizarNI = async (id, i, ni) => {
  const ref = doc(db, "pedidos", id);
  const snap = await getDoc(ref);
  if (!snap.exists()) return;

  const p = snap.data();
  p.pecas[i].ni = ni.trim();

  await updateDoc(ref, { pecas: p.pecas });

  // ğŸ”„ Recarrega para recalcular faltaNI e liberar Aprovar
  carregarPedidos();
};

/* APRENDER */
async function aprender(p){
  for(const x of p.pecas){
    if(!x.ni) continue;

    const descricaoNorm = norm(x.descricao);
    const niLimpo = x.ni.trim();

    // ğŸ” verifica se jÃ¡ existe
    const q = query(
      collection(db, "aprendizado_ni"),
      where("descricao", "==", descricaoNorm),
      where("ni", "==", niLimpo)
    );

    const snap = await getDocs(q);

    // âŒ se jÃ¡ existe, NÃƒO salva de novo
    if (!snap.empty) continue;

    // âœ… se nÃ£o existe, aprende
    await addDoc(collection(db,"aprendizado_ni"),{
      descricao: descricaoNorm,
      ni: niLimpo,
      validadoEm: new Date()
    });
  }
}


/* STATUS + TELEGRAM */
window.mudarStatus=async(id,status)=>{
  const ref=doc(db,"pedidos",id);
  const p=(await getDoc(ref)).data();
  if(p.status!=="Pendente")return;

  await updateDoc(ref, {
  status,
  finalizadoEm: new Date(),
  aprovadoPor: localStorage.getItem("usuario_nome") || "NÃ£o identificado"
});
  if(status==="Aprovado")await aprender(p);

  const agora = new Date().toLocaleString("pt-BR");

const tituloTelegram =
  p.tipo === "DEVOLUCAO"
    ? "ğŸ” *PEDIDO DE DEVOLUÃ‡ÃƒO APROVADO*"
    : "ğŸ§° *PEDIDO DE PEÃ‡AS APROVADO*";

await enviarTelegram(
`${tituloTelegram}

ğŸ‘¤ *Solicitante:* ${p.nome}
ğŸ›  *ManutenÃ§Ã£o:* ${p.manutencao}
ğŸšš *GO:* ${p.go || "-"}

ğŸ“¦ *PeÃ§as:*
${p.pecas.map(x => `â€¢ ${x.descricao} (${x.quantidade}) | NI: ${x.ni || "-"}`).join("\n")}

ğŸ‘·â€â™‚ï¸ *Aprovado por:* ${localStorage.getItem("usuario_nome") || "NÃ£o identificado"}
â° *Data:* ${agora}`
);

  carregarPedidos();
}

/* EXCLUIR */
window.excluir=async(id)=>{
  if(confirm("Excluir pedido pendente?")){
    await deleteDoc(doc(db,"pedidos",id));
    carregarPedidos();
  }
}

/* RELATÃ“RIO */
window.gerarRelatorioDia = () => {
  const hoje = new Date().toISOString().split("T")[0];
  document.getElementById("inicio").value = hoje;
  document.getElementById("fim").value = hoje;
  gerarRelatorioPeriodo();
};

window.gerarRelatorioPeriodo = async () => {
  const inicio = document.getElementById("inicio").value;
  const fim = document.getElementById("fim").value;

  if (!inicio || !fim) {
    alert("Selecione a data inicial e final");
    return;
  }

  const dataInicio = new Date(inicio + "T00:00:00");
  const dataFim = new Date(fim + "T23:59:59");

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("landscape");

  const snap = await getDocs(collection(db, "pedidos"));
  const rows = [];

  snap.forEach(d => {
    const p = d.data();
    if (!p.criadoEm) return;

    const criadoEm = p.criadoEm.toDate(); // ğŸ”‘ converte Timestamp

    if (criadoEm >= dataInicio && criadoEm <= dataFim) {
      rows.push([
        p.nome,
        p.manutencao,
        p.go || "-",
        p.pecas.map(x => `${x.descricao} (${x.quantidade})`).join("\n"),
        p.status,
        criadoEm.toLocaleString("pt-BR")
      ]);
    }
  });

  if (rows.length === 0) {
    alert("Nenhum pedido encontrado no perÃ­odo selecionado");
    return;
  }

  pdf.autoTable({
    head: [[
      "Solicitante",
      "ManutenÃ§Ã£o",
      "GO",
      "PeÃ§as",
      "Status",
      "Criado em"
    ]],
    body: rows
  });

  pdf.save("relatorio-pedidos.pdf");
};

const normalizarPeca = t =>
  t.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();

async function gerarRelatorioPecas(dataInicio, dataFim, titulo) {
  const snap = await getDocs(collection(db, "pedidos"));
  const contador = {};

  snap.forEach(d => {
    const p = d.data();
    if (!p.criadoEm) return;
    if (p.status !== "Aprovado") return;
    if (p.tipo === "DEVOLUCAO") return;

    const criadoEm = p.criadoEm.toDate();
    if (criadoEm < dataInicio || criadoEm > dataFim) return;

    p.pecas.forEach(x => {
      const nome = normalizarPeca(x.descricao);
      const qtd = Number(x.quantidade) || 0;

      contador[nome] = (contador[nome] || 0) + qtd;
    });
  });

  const linhas = Object.entries(contador)
    .sort((a,b) => b[1] - a[1])
    .map(([nome, qtd]) => [nome, qtd]);

  if (linhas.length === 0) {
    alert("Nenhuma peÃ§a encontrada no perÃ­odo");
    return;
  }

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  pdf.setFontSize(14);
  pdf.text(titulo, 14, 15);

  pdf.autoTable({
    startY: 20,
    head: [["PeÃ§a", "Quantidade Total"]],
    body: linhas
  });

  pdf.save(`${titulo}.pdf`);
}

window.relatorioPecasDia = () => {
  const hoje = new Date();
  const inicio = new Date(hoje.setHours(0,0,0,0));
  const fim = new Date(hoje.setHours(23,59,59,999));

  gerarRelatorioPecas(
    inicio,
    fim,
    "RelatÃ³rio diÃ¡rio â€“ PeÃ§as mais usadas"
  );
};

window.relatorioPecasSemana = () => {
  const fim = new Date();
  const inicio = new Date();
  inicio.setDate(fim.getDate() - 6);
  inicio.setHours(0,0,0,0);

  gerarRelatorioPecas(
    inicio,
    fim,
    "RelatÃ³rio semanal â€“ PeÃ§as mais usadas"
  );
};

/* AUTOLOGIN */
if(localStorage.getItem("admin")==="true"){
  loginBox.style.display="none";
  painel.style.display="block";
  carregarPedidos();
}


</script>

</body>
</html>
