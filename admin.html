<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>√Årea de Pedidos ‚Äì Almoxarifado CMC</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest-admin.json">
<meta name="theme-color" content="#111827">

<style>
body{
  font-family:Arial,Helvetica,sans-serif;
  background:#f3f4f6;
  padding:15px;
}

.logo{text-align:center;margin-bottom:10px}
.logo img{max-width:160px;width:100%}

footer{
  text-align:center;
  font-size:11px;
  color:#6b7280;
  margin-bottom:10px;
}

.login,.painel{
  max-width:1300px;
  margin:auto;
  background:#fff;
  padding:15px;
  border-radius:14px;
  box-shadow:0 8px 20px rgba(0,0,0,.08);
}

h2{text-align:center;margin-bottom:15px}

/* üîπ LAYOUT */
.layout{
  display:grid;
  grid-template-columns:260px 1fr;
  gap:15px;
}

/* üìÑ RELAT√ìRIOS */
.relatorio-card{
  background:#f9fafb;
  border-radius:14px;
  padding:15px;
  box-shadow:inset 0 0 0 1px #e5e7eb;
}

.relatorio-card h3{
  font-size:15px;
  margin-bottom:10px;
  color:#111827;
}

.relatorio-card label{
  font-size:12px;
  color:#374151;
  display:block;
  margin-top:8px;
}

.relatorio-card input{
  width:100%;
  padding:7px;
  border-radius:8px;
  border:1px solid #d1d5db;
  margin-top:4px;
}

.relatorio-card button{
  width:100%;
  margin-top:10px;
  padding:9px;
  border-radius:10px;
  border:none;
  background:#2563eb;
  color:#fff;
  font-weight:bold;
  cursor:pointer;
}

.relatorio-card button:hover{opacity:.9}

/* üîπ BOT√ïES GERAIS */
button{
  padding:7px 11px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  font-size:13px;
}

.aprovar{background:#16a34a;color:#fff}
.reprovar{background:#dc2626;color:#fff}
.aprovar:disabled{background:#9ca3af;cursor:not-allowed}

.btn-excluir{
  background:none;
  color:#dc2626;
  font-size:16px;
}

.btn-sair{background:#111827;color:#fff}
.btn-refresh{background:#2563eb;color:#fff}

/* üîπ TABELA */
table{width:100%;border-collapse:collapse}
th,td{
  border:1px solid #d1d5db;
  padding:6px;
  font-size:13px;
}
th{background:#f3f4f6}

.status-pendente{color:#ca8a04;font-weight:bold}
.status-aprovado{color:#16a34a;font-weight:bold}
.status-reprovado{color:#dc2626;font-weight:bold}

.card-pendente{
  background:#fffbeb;
  border-left:6px solid #f59e0b;
}

.selo-finalizado{
  background:#e5e7eb;
  padding:6px 10px;
  border-radius:20px;
  font-size:12px;
  font-weight:bold;
}

/* üì± MOBILE */
@media(max-width:900px){
  .layout{grid-template-columns:1fr}
  table,thead,tbody,tr,td{display:block}
  thead{display:none}
  tr{
    margin-bottom:15px;
    padding:12px;
    border-radius:14px;
    background:#fff;
    box-shadow:0 6px 14px rgba(0,0,0,.08);
  }
  td{border:none}
  td::before{
    content:attr(data-label);
    font-weight:bold;
    display:block;
    margin-bottom:3px;
  }
}
</style>
</head>

<body>

<div class="logo">
  <a href="index.html">
    <img src="suzano-logo.png">
  </a>
</div>

<footer>Criado e Desenvolvido por Cleider Filho</footer>

<div class="login" id="loginBox">
  <h2>üîê √Årea de T√©cnicos</h2>
  <input type="password" id="senha" placeholder="Senha">
  <button id="btnLogin">Entrar</button>
</div>

<div class="painel" id="painel" style="display:none">
  <h2>üì¶ Pedidos Recebidos</h2>

  <div class="layout">

    <!-- üìÑ RELAT√ìRIOS -->
    <div class="relatorio-card">
      <h3>üìÑ Relat√≥rios</h3>

      <button onclick="gerarRelatorio()">üìÖ Relat√≥rio do dia</button>

      <label>Data inicial</label>
      <input type="date" id="dataInicio">

      <label>Data final</label>
      <input type="date" id="dataFim">

      <button onclick="gerarRelatorioPeriodo()">üìÜ Relat√≥rio por per√≠odo</button>

      <hr style="margin:12px 0">

      <button class="btn-refresh" onclick="carregarPedidos()">üîÑ Atualizar pedidos</button>
      <button class="btn-sair" onclick="logout()">üö™ Sair</button>
    </div>

    <!-- üì¶ PEDIDOS -->
    <div>
      <table>
        <thead>
          <tr>
            <th>Solicitante</th>
            <th>Manuten√ß√£o</th>
            <th>GO</th>
            <th>Pe√ßas / NI</th>
            <th>Status</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="lista"></tbody>
      </table>
    </div>

  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, getDocs,
  doc, updateDoc, getDoc, query, orderBy, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyBsF6D5l1dXR4rSR3axpFrD-idXh2ZaRUE",
  projectId: "testeer-1516c"
});
const db = getFirestore(app);

/* üì≤ TELEGRAM */
const TELEGRAM_TOKEN = "8229775934:AAEEIKF5ffP_rVvbosRilvPyb3wZ0fVBFLU";
const TELEGRAM_CHAT_ID = "-1003208006500";

function notificarTelegramAprovado(p){
  const texto = `
‚úÖ PEDIDO APROVADO

Solicitante: ${p.nome}
Manuten√ß√£o: ${p.manutencao}
GO: ${p.go || "-"}

Pe√ßas:
${p.pecas.map(x=>`- ${x.descricao} (${x.quantidade}) | NI: ${x.ni}`).join("\n")}

Aprovado por: ${p.aprovadoPor}
Data: ${new Date().toLocaleString("pt-BR")}
`;
  fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ chat_id:TELEGRAM_CHAT_ID, text:texto })
  });
}

/* LOGIN */
btnLogin.onclick = ()=>{
  localStorage.setItem("adminLogado","true");
  localStorage.setItem("adminNome","T√©cnico");
  loginBox.style.display="none";
  painel.style.display="block";
  carregarPedidos();
};

window.logout = ()=>{
  localStorage.clear();
  location.reload();
};

/* LISTAR */
async function carregarPedidos(){
  lista.innerHTML="";
  const q=query(collection(db,"pedidos"),orderBy("criadoEm","desc"));
  const snap=await getDocs(q);

  snap.forEach(d=>{
    const p=d.data();
    const faltaNI=p.pecas.some(x=>!x.ni);
    const finalizado=p.status!=="Pendente";

    lista.innerHTML+=`
<tr class="${p.status==="Pendente"?"card-pendente":""}">
<td data-label="Solicitante">${p.nome}</td>
<td data-label="Manuten√ß√£o">${p.manutencao}</td>
<td data-label="GO">${p.go||"-"}</td>
<td data-label="Pe√ßas">
${p.pecas.map((x,i)=>`
<b>${x.descricao}</b><br>
NI:
<input value="${x.ni||""}" ${finalizado?"disabled":""}
onchange="atualizarNI('${d.id}',${i},this.value)">
`).join("<hr>")}
</td>
<td data-label="Status"><span class="status-${p.status.toLowerCase()}">${p.status}</span></td>
<td data-label="A√ß√µes">
${finalizado
? `<div class="selo-finalizado">‚úî Pedido Finalizado</div>`
: `
<button class="aprovar" ${faltaNI?"disabled":""}
onclick="mudarStatus('${d.id}','Aprovado')">Aprovar</button>
<button class="reprovar" onclick="mudarStatus('${d.id}','Reprovado')">Reprovar</button>
<button class="btn-excluir" onclick="excluirPedido('${d.id}')">‚ùå</button>
`}
</td>
</tr>`;
  });
}

window.atualizarNI=async(id,idx,ni)=>{
  const ref=doc(db,"pedidos",id);
  const snap=await getDoc(ref);
  const p=snap.data();
  p.pecas[idx].ni=ni;
  await updateDoc(ref,{pecas:p.pecas});
  carregarPedidos();
};

window.mudarStatus=async(id,status)=>{
  const ref=doc(db,"pedidos",id);
  const snap=await getDoc(ref);
  const p=snap.data();
  if(p.status!=="Pendente") return;

  p.status=status;
  p.aprovadoPor=localStorage.getItem("adminNome");
  await updateDoc(ref,p);

  if(status==="Aprovado") notificarTelegramAprovado(p);
  carregarPedidos();
};

window.excluirPedido=async(id)=>{
  if(!confirm("Excluir pedido pendente?")) return;
  await deleteDoc(doc(db,"pedidos",id));
  carregarPedidos();
};

/* üìÑ RELAT√ìRIOS */
window.gerarRelatorio=()=>gerarRelatorioPeriodo(true);

window.gerarRelatorioPeriodo=async()=>{
  const { jsPDF } = window.jspdf;
  const pdf=new jsPDF("landscape");
  const snap=await getDocs(collection(db,"pedidos"));
  const linhas=[];
  snap.forEach(d=>{
    const p=d.data();
    linhas.push([
      p.nome,p.manutencao,p.go||"-",
      p.pecas.map(x=>`${x.descricao} (${x.ni})`).join("\n"),
      p.status
    ]);
  });
  pdf.autoTable({
    head:[["Solicitante","Manuten√ß√£o","GO","Pe√ßas","Status"]],
    body:linhas
  });
  pdf.save("relatorio-pedidos.pdf");
};

if(localStorage.getItem("adminLogado")==="true"){
  loginBox.style.display="none";
  painel.style.display="block";
  carregarPedidos();
}
</script>
</body>
</html>